<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>متجري الجزائري</title>
  <style>
    /* ... نفس الستايلات تماماً، لا تغيير هنا ... */
    body { font-family: 'Tahoma', 'Arial', sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
    h1, h2 { text-align: center; color: #0056b3; }
    .products-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .product { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white; display: flex; flex-direction: column; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .product:hover { transform: translateY(-5px); }
    .product img { max-width: 100%; height: 200px; object-fit: cover; border-radius: 5px; margin-bottom: 15px; }
    .product-info { flex-grow: 1; }
    .product-price { font-size: 1.2em; font-weight: bold; color: #28a745; margin: 10px 0; }
    .add-to-cart-btn { background-color: #007bff; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; width: 100%; font-size: 1em; transition: background-color 0.2s; }
    .add-to-cart-btn:hover { background-color: #0056b3; }
    #cart, #orderForm { margin-top: 30px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .cart-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .cart-table th, .cart-table td { border: 1px solid #ddd; padding: 10px; text-align: center; vertical-align: middle; }
    .cart-table th { background-color: #f2f2f2; }
    .quantity-input { width: 60px; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
    .remove-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
    form label { display: block; margin-bottom: 10px; }
    form input, form select { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    form button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; width: 100%; }
    form button:disabled { background-color: #aaa; cursor: not-allowed; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 10px; position: relative; }
    .close-btn { color: #aaa; position: absolute; left: 15px; top: 5px; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-btn:hover, .close-btn:focus { color: black; }
    .modal-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
    .modal-buttons button { width: 48%; }
    #confirm-order-btn { background-color: #28a745; }
    #cancel-order-btn { background-color: #6c757d; }
  </style>
</head>
<body>

<h1>المنتجات المتوفرة</h1>
<div id="products-container" class="products-container"></div>

<h2>🛒 سلة المشتريات</h2>
<div id="cart"><p>السلة فارغة حالياً.</p></div>

<h2>📦 معلومات الشحن والتوصيل</h2>
<!-- **تعديل مهم**: أضفنا حقل _next لتوجيه المستخدم بعد إرسال الفورم -->
<form id="orderForm" action="https://formsubmit.co/cherif14200@gmail.com" method="POST">
  <input type="hidden" name="_subject" value="طلب جديد من المتجر">
  <input type="hidden" name="_captcha" value="false">
  <input type="hidden" name="_next" value="https://your-website.com/index2.htmlthankyou.html"> <!-- سيتم تعديل هذا الرابط لاحقاً -->

  <input type="hidden" name="cart_items" id="cartData">
  <input type="hidden" name="delivery_cost" id="deliveryCost">
  <input type="hidden" name="final_total_price" id="cartTotal">

  <label for="name">الاسم الكامل:</label>
  <input type="text" id="name" name="name" required>

  <label for="phone">رقم الهاتف:</label>
  <input type="tel" id="phone" name="phone" required>

  <label for="wilaya">الولاية:</label>
  <select id="wilaya" name="wilaya" required><option value="">اختر الولاية...</option></select>

  <label for="commune">البلدية:</label>
  <select id="commune" name="commune" required><option value="">اختر البلدية أولاً...</option></select>

  <label for="address">العنوان الكامل (الحي، الشارع، إلخ):</label>
  <input type="text" id="address" name="address" required>

  <button type="submit" id="submitBtn">إتمام عملية الشراء</button>
</form>

<!-- ===== نافذة التأكيد المنبثقة (Modal) ===== -->
<div id="confirmationModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">×</span>
    <h2>📝 مراجعة الطلب</h2>
    <div id="confirmation-summary"></div>
    <div class="modal-buttons">
        <button id="cancel-order-btn">إلغاء</button>
        <button id="confirm-order-btn">تأكيد الطلب</button>
    </div>
  </div>
</div>

<script>
const PRODUCTS_URL = "https://script.google.com/macros/s/AKfycbwAYiOFNt4eGtmSclHWBSJaMwMhSzois2-BP_uchEVhoBs7ga_CB67qi1uz_lGUgVay/exec";
const DZ_DATA_URL = "dz.json";
const DELIVERY_COSTS = {
  "الجزائر": 400, "وهران": 450, "قسنطينة": 450, "البليدة": 350, "بومرداس": 350, "تيبازة": 350,
  "default": 600
};

let cart = [];
let dzData = {};

document.addEventListener('DOMContentLoaded', () => {
    // **تعديل مهم**: تحديد رابط صفحة الشكر ديناميكياً
    const thankYouPageUrl = window.location.origin + window.location.pathname.replace('index.html', '') + 'thankyou.html';
    document.querySelector('input[name="_next"]').value = thankYouPageUrl;
    
    loadProducts();
    loadWilayas();
    renderCart();
});

const wilayaSelect = document.getElementById('wilaya');
const communeSelect = document.getElementById('commune');
const orderForm = document.getElementById('orderForm');
const modal = document.getElementById('confirmationModal');
const closeBtn = document.querySelector('.close-btn');
const confirmBtn = document.getElementById('confirm-order-btn');
const cancelBtn = document.getElementById('cancel-order-btn');

function loadProducts() { /* ... نفس الكود بدون تغيير ... */
  fetch(PRODUCTS_URL).then(res => res.json()).then(displayProducts).catch(err => {
    document.getElementById('products-container').innerHTML = '<p>عذراً، حدث خطأ أثناء تحميل المنتجات.</p>'; console.error(err);
  });
}

function loadWilayas() { /* ... نفس الكود بدون تغيير ... */
  fetch(DZ_DATA_URL).then(res => res.json()).then(data => {
    dzData = data;
    Object.keys(dzData).sort().forEach(wilaya => wilayaSelect.appendChild(new Option(wilaya, wilaya)));
  }).catch(err => { console.error("خطأ في تحميل ملف الولايات:", err); alert("لا يمكن تحميل قائمة الولايات والبلديات."); });
}

function displayProducts(products) { /* ... نفس الكود بدون تغيير ... */
  const container = document.getElementById('products-container');
  container.innerHTML = '';
  products.forEach(p => {
    if (p.id && parseInt(p.quantity) > 0) {
      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `<img src="${p.image}" alt="${p.name}" /><div class="product-info"><h3>${p.name}</h3><p>${p.description}</p><p class="product-price">${p.price} دج</p></div><button class="add-to-cart-btn" onclick='addToCart(${JSON.stringify(p)})'>أضف إلى السلة</button>`;
      container.appendChild(div);
    }
  });
}

function addToCart(product) { /* ... نفس الكود بدون تغيير ... */
  const existingProduct = cart.find(item => item.id == product.id);
  if (existingProduct) { existingProduct.quantity++; } else { cart.push({ ...product, quantity: 1 }); }
  alert(`تمت إضافة "${product.name}" إلى السلة بنجاح!`);
  renderCart();
}

function removeFromCart(productId) {
  cart = cart.filter(item => item.id != productId);
  renderCart();
}

// **إصلاح**: تعديل دالة تحديث الكمية لتعمل بشكل صحيح
function updateQuantity(productId, newQuantity) {
  const product = cart.find(item => item.id == productId); // استخدام '==' للمقارنة غير الصارمة (نص مع رقم)
  if (product) {
    product.quantity = Math.max(1, newQuantity); // الكمية لا تقل عن 1
  }
  renderCart();
}

function renderCart() { /* ... نفس الكود بدون تغيير ... */
  const cartContainer = document.getElementById('cart');
  if (cart.length === 0) { cartContainer.innerHTML = "<p>السلة فارغة حالياً.</p>"; return; }

  const cartSubtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
  const selectedWilaya = wilayaSelect.value;
  const deliveryCost = selectedWilaya ? (DELIVERY_COSTS[selectedWilaya] || DELIVERY_COSTS.default) : 0;
  const finalTotal = cartSubtotal + deliveryCost;

  // **تعديل بسيط**: تمرير الـ id المنتج لدالة التحديث
  const cartItemsHtml = cart.map(item => {
    const itemTotal = parseFloat(item.price) * item.quantity;
    return `<tr><td>${item.name}</td><td>${item.price} دج</td><td><input type="number" class="quantity-input" value="${item.quantity}" min="1" onchange="updateQuantity('${item.id}', this.valueAsNumber)"></td><td>${itemTotal.toFixed(2)} دج</td><td><button class="remove-btn" onclick="removeFromCart('${item.id}')">حذف</button></td></tr>`;
  }).join('');

  cartContainer.innerHTML = `<table class="cart-table"><thead><tr><th>المنتج</th><th>السعر</th><th>الكمية</th><th>الإجمالي</th><th>إجراء</th></tr></thead><tbody>${cartItemsHtml}</tbody><tfoot><tr><td colspan="4">المجموع الفرعي</td><td><strong>${cartSubtotal.toFixed(2)} دج</strong></td></tr><tr><td colspan="4">تكلفة التوصيل (${selectedWilaya || 'اختر ولاية'})</td><td><strong>${deliveryCost.toFixed(2)} دج</strong></td></tr><tr style="background-color:#e9f5e9;"><td colspan="4"><strong>المجموع الكلي</strong></td><td><strong>${finalTotal.toFixed(2)} دج</strong></td></tr></tfoot></table>`;
}

wilayaSelect.addEventListener('change', () => { /* ... نفس الكود بدون تغيير ... */
  communeSelect.innerHTML = '<option value="">اختر البلدية...</option>';
  const selectedWilaya = wilayaSelect.value;
  if (selectedWilaya && dzData[selectedWilaya]) {
    dzData[selectedWilaya].forEach(commune => communeSelect.appendChild(new Option(commune, commune)));
  }
  renderCart();
});

orderForm.addEventListener('submit', function(e) { /* ... نفس الكود بدون تغيير ... */
  e.preventDefault();
  if (cart.length === 0) { alert("❌ السلة فارغة!"); return; }
  if (!orderForm.checkValidity()) { alert("❌ يرجى ملء جميع الحقول المطلوبة."); orderForm.reportValidity(); return; }
  showConfirmationModal();
});

function showConfirmationModal() { /* ... نفس الكود بدون تغيير ... */
  const summaryContainer = document.getElementById('confirmation-summary');
  const name = document.getElementById('name').value, phone = document.getElementById('phone').value, wilaya = document.getElementById('wilaya').value, commune = document.getElementById('commune').value, address = document.getElementById('address').value;
  const cartSubtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
  const deliveryCost = DELIVERY_COSTS[wilaya] || DELIVERY_COSTS.default;
  const finalTotal = cartSubtotal + deliveryCost;
  const itemsList = cart.map(item => `<li>${item.name} (الكمية: ${item.quantity}) - ${item.price} دج</li>`).join('');

  summaryContainer.innerHTML = `<h4>المنتجات:</h4><ul>${itemsList}</ul><hr><p><strong>المجموع الفرعي:</strong> ${cartSubtotal.toFixed(2)} دج</p><p><strong>تكلفة التوصيل:</strong> ${deliveryCost.toFixed(2)} دج</p><h3><strong>السعر النهائي: ${finalTotal.toFixed(2)} دج</strong></h3><hr><h4>معلومات التوصيل:</h4><p><strong>الاسم:</strong> ${name}</p><p><strong>الهاتف:</strong> ${phone}</p><p><strong>العنوان:</strong> ${address}, ${commune}, ${wilaya}</p>`;
  document.getElementById('cartData').value = cart.map(p => `${p.name} (x${p.quantity})`).join(" | ");
  document.getElementById('deliveryCost').value = `${deliveryCost.toFixed(2)} دج`;
  document.getElementById('cartTotal').value = `${finalTotal.toFixed(2)} دج`;
  modal.style.display = 'block';
}

closeBtn.onclick = () => { modal.style.display = 'none'; };
cancelBtn.onclick = () => { modal.style.display = 'none'; };
window.onclick = (event) => { if (event.target == modal) { modal.style.display = 'none'; } };
confirmBtn.onclick = () => {
  confirmBtn.disabled = true;
  confirmBtn.textContent = 'جاري الإرسال...';
  orderForm.submit();
};
</script>

</body>
</html>

</body>
  </html>

